<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>model_api &mdash; repoclass 1.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=19f00094" />

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../_static/jquery.js?v=5d32c60e"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../_static/documentation_options.js?v=f2a433a1"></script>
        <script src="../_static/doctools.js?v=9a2dae69"></script>
        <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            repoclass
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../modules.html">Modules</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">repoclass</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="index.html">Module code</a></li>
      <li class="breadcrumb-item active">model_api</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for model_api</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">This module provides classes and functions for creating, training and configuring a categoric neural network model.</span>

<span class="sd">Classes:</span>
<span class="sd">    - ConfigRun: A dataclass to store the default configuration for the model training.</span>

<span class="sd">Functions:</span>
<span class="sd">    - configure_default_loggers(fil_name: str = None, fil_dir: str = None): Configure the default loggers for the module.</span>
<span class="sd">    - wipe_handlers(): Wipe the loggers from the root logger.</span>
<span class="sd">    - reconfigure_loggers(): Reconfigure the loggers.</span>
<span class="sd">    - configure_dataset(df: pd.DataFrame, input_columns: list, output_columns: list) -&gt; CategoricDataset: Configure the dataset for training the model.</span>
<span class="sd">    - get_dataloaders(dataset: CategoricDataset, train_size: float = None, batch_size: int = None, balance_training_data: bool = True, aggregate_outputs: bool = True) -&gt; tuple: Get the dataloaders for the training and testing of the model.</span>
<span class="sd">    - create_model(dataset: CategoricDataset, use_input_embedding: bool = None, use_output_embedding: bool = None, max_hidden_neurons: int = None, hidden_layers: int = None, train_nlp_embedding: bool = None, nlp_model_name: str = None) -&gt; CategoricNeuralNetwork</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">dataclasses</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">import</span> <span class="nn">matplotlib</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">from</span> <span class="nn">torch.utils.data</span> <span class="kn">import</span> <span class="n">DataLoader</span>
<span class="kn">from</span> <span class="nn">dataset_define</span> <span class="kn">import</span> <span class="n">CategoricDataset</span>
<span class="kn">from</span> <span class="nn">learning_model</span> <span class="kn">import</span> <span class="n">CategoricNeuralNetwork</span><span class="p">,</span> <span class="n">StopTraining</span>
<span class="kn">import</span> <span class="nn">set_logger</span>
<span class="n">logger</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">Logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;TFM&quot;</span><span class="p">)</span>
<span class="n">printer</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">Logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;printer&quot;</span><span class="p">)</span>
<span class="n">matplotlib</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s2">&quot;Agg&quot;</span><span class="p">)</span>


<div class="viewcode-block" id="ConfigRun">
<a class="viewcode-back" href="../model_api.html#model_api.ConfigRun">[docs]</a>
<span class="nd">@dataclasses</span><span class="o">.</span><span class="n">dataclass</span>
<span class="k">class</span> <span class="nc">ConfigRun</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A dataclass to store the default configuration for the model training.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        balance_training_data (bool): Whether to balance the training data.</span>
<span class="sd">        aggregate_outputs (bool): Whether to aggregate the outputs.</span>
<span class="sd">        max_hidden_neurons (int): The maximum number of hidden neurons in the model.</span>
<span class="sd">        hidden_layers (int): The number of hidden layers in the model.</span>
<span class="sd">        model_uses_input_embedding (bool): Whether the model uses input embedding.</span>
<span class="sd">        model_uses_output_embedding (bool): Whether the model uses output embedding.</span>
<span class="sd">        model_trains_nlp_embedding (bool): Whether the model trains the NLP embedding.</span>
<span class="sd">        learning_rate (float): The learning rate for the model.</span>
<span class="sd">        batch_size (int): The batch size for the model.</span>
<span class="sd">        epochs (int): The number of epochs for the model.</span>
<span class="sd">        train_size (float): The proportion of the dataset to be used for training.</span>
<span class="sd">        train_targets (dict): The targets for the training.</span>
<span class="sd">        optimizer_name (str): The name of the optimizer to be used.</span>
<span class="sd">        nlp_model_name (str): The name of the NLP model to be used.</span>
<span class="sd">        lr_decay_factor (float): The factor by which the learning rate will be decayed.</span>
<span class="sd">        scheduler_type (str): The type of the scheduler.</span>
<span class="sd">        scheduler_plateau_mode (str): The mode for the scheduler.</span>
<span class="sd">        lr_decay_patience (int): The patience for the scheduler.</span>
<span class="sd">        lr_decay_target (str): The target for the learning rate decay.</span>
<span class="sd">        lr_decay_step (int): The steps for the scheduler.</span>
<span class="sd">        out_dir (Path): The directory to save the reports and outputs.</span>
<span class="sd">        case_name (str): The name of the case.</span>
<span class="sd">        report_dir (str): The directory to save the reports.</span>
<span class="sd">        report_filename (str): The name of the report file.</span>

<span class="sd">    Methods:</span>
<span class="sd">        None</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Preprocessing parameters</span>
    <span class="n">balance_training_data</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">aggregate_outputs</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="c1"># Model parameters</span>
    <span class="n">max_hidden_neurons</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2058</span>
    <span class="n">hidden_layers</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">model_uses_input_embedding</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">model_uses_output_embedding</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">model_trains_nlp_embedding</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="c1"># Training parameters</span>
    <span class="n">learning_rate</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1e-3</span>
    <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">32</span>
    <span class="n">epochs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">15</span>
    <span class="n">train_size</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.8</span>
    <span class="n">train_targets</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;f1&quot;</span><span class="p">:</span> <span class="mf">0.75</span><span class="p">})</span>
    <span class="c1"># Optimizer</span>
    <span class="n">optimizer_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;AdamW&quot;</span>
    <span class="n">nlp_model_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;huggingface/CodeBERTa-small-v1&quot;</span>
    <span class="c1"># Scheduler: Learning rate multiplicative factor</span>
    <span class="n">lr_decay_factor</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span>
    <span class="n">scheduler_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="c1"># Scheduler: relevant only if Reduce on Plateau</span>
    <span class="n">scheduler_plateau_mode</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;max&quot;</span>
    <span class="n">lr_decay_patience</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span>
    <span class="n">lr_decay_target</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;f1&quot;</span>
    <span class="c1"># Scheduler: relevant only if reduce on step</span>
    <span class="n">lr_decay_step</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span>
    <span class="c1"># Reports and outputs</span>
    <span class="n">out_dir</span><span class="p">:</span> <span class="n">Path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;out&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span>
    <span class="n">case_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;default&quot;</span>
    <span class="n">report_dir_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;reports&quot;</span>
    <span class="n">report_filename</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;report&quot;</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">out_case_dir</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">out_dir</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">case_name</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">report_dir</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">out_case_dir</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">report_dir_name</span><span class="p">)</span>

<div class="viewcode-block" id="ConfigRun.print">
<a class="viewcode-back" href="../model_api.html#model_api.ConfigRun.print">[docs]</a>
    <span class="k">def</span> <span class="nf">print</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Print all config values</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;__&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">key</span> <span class="o">!=</span> <span class="s2">&quot;print&quot;</span> <span class="ow">and</span> <span class="n">key</span> <span class="o">!=</span> <span class="s2">&quot;out_case_dir&quot;</span> <span class="ow">and</span> <span class="n">key</span> <span class="o">!=</span> <span class="s2">&quot;report_dir&quot;</span><span class="p">:</span>
                <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out</span><span class="p">)</span></div>


<div class="viewcode-block" id="ConfigRun.to_dict">
<a class="viewcode-back" href="../model_api.html#model_api.ConfigRun.to_dict">[docs]</a>
    <span class="k">def</span> <span class="nf">to_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert the ConfigRun instance to a dictionary, converting Paths to strings.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">))</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">),</span> <span class="n">Path</span><span class="p">)</span> <span class="k">else</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">fields</span><span class="p">(</span><span class="bp">self</span><span class="p">)}</span></div>


<div class="viewcode-block" id="ConfigRun.from_dict">
<a class="viewcode-back" href="../model_api.html#model_api.ConfigRun.from_dict">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_dict</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">dict_</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a ConfigRun instance from a dictionary, converting strings to Paths where necessary.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dict_</span><span class="p">[</span><span class="s1">&#39;out_dir&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">dict_</span><span class="p">[</span><span class="s1">&#39;out_dir&#39;</span><span class="p">])</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="o">**</span><span class="n">dict_</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="ModelApi">
<a class="viewcode-back" href="../model_api.html#model_api.ModelApi">[docs]</a>
<span class="k">class</span> <span class="nc">ModelApi</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A class to store the functions for creating, training and configuring a categoric neural network model.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        None</span>

<span class="sd">    Methods:</span>
<span class="sd">        configure_default_loggers(fil_name: str = None, fil_dir: str = None): Configure the default loggers for the module.</span>
<span class="sd">        wipe_handlers(): Wipe the loggers from the root logger.</span>
<span class="sd">        reconfigure_loggers(): Reconfigure the loggers.</span>
<span class="sd">        configure_dataset(df: pd.DataFrame, input_columns: list, output_columns: list) -&gt; CategoricDataset: Configure the dataset for training the model.</span>
<span class="sd">        get_dataloaders(dataset: CategoricDataset, train_size: float = None, batch_size: int = None, balance_training_data: bool = True, aggregate_outputs: bool = True) -&gt; tuple: Get the dataloaders for the training and testing of the model.</span>
<span class="sd">        create_model(dataset: CategoricDataset, use_input_embedding: bool = None, use_output_embedding: bool = None, max_hidden_neurons: int = None, hidden_layers: int = None, train_nlp_embedding: bool = None, nlp_model_name: str = None) -&gt; CategoricNeuralNetwork</span>
<span class="sd">        get_optimizer(model: CategoricNeuralNetwork, learning_rate: float = None, optimizer_name: str = &quot;AdamW&quot;) -&gt; torch.optim.Optimizer</span>
<span class="sd">        get_scheduler(optimizer: torch.optim.Optimizer, factor: float = 0.1, mode: str = None, patience: int = None, steps: int = None, scheduler_type: str = None) -&gt; torch.optim.lr_scheduler._LRScheduler</span>
<span class="sd">        get_loss_fn(use_output_embedding: bool = None) -&gt; torch.nn.Module</span>
<span class="sd">        train(model: CategoricNeuralNetwork, train_dataloader: DataLoader, test_dataloader: DataLoader, loss_fn: torch.nn.Module, optimizer: torch.optim.Optimizer, train_targets: dict = None, epochs: int = None, lr_decay_target: str = None, scheduler: torch.optim.lr_scheduler._LRScheduler | None = None, do_report: bool = True, live_report: bool = False) -&gt; None</span>
<span class="sd">        build_and_train_model(df: pd.DataFrame, input_columns: list, output_columns: list) -&gt; CategoricNeuralNetwork</span>
<span class="sd">        save_model(model: CategoricNeuralNetwork, path: str) -&gt; None</span>
<span class="sd">        load_model(path: str) -&gt; CategoricNeuralNetwork</span>
<span class="sd">        add_output_posssibilities(df: pd.DataFrame,  output_category: str, output_value: str) -&gt; pd.DataFrame</span>
<span class="sd">        &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">ConfigRun</span><span class="p">()</span>

<div class="viewcode-block" id="ModelApi.configure_default_loggers">
<a class="viewcode-back" href="../model_api.html#model_api.ModelApi.configure_default_loggers">[docs]</a>
    <span class="k">def</span> <span class="nf">configure_default_loggers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fil_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Configure the default loggers for the module.</span>

<span class="sd">        Those are loggers named &quot;TFM&quot; and &quot;printer&quot;.</span>
<span class="sd">        They will be handled by the root logger, as they emit messages</span>
<span class="sd">        from throughout the application. The user can use them to</span>
<span class="sd">        print messages to the console or to save them in a log file, and</span>
<span class="sd">        the logging hierarchy will be respected.</span>

<span class="sd">        Args:</span>
<span class="sd">            fil_name (str): The name of the file to save the logs.</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">fil_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fil_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">report_filename</span>
            <span class="n">fil_path</span><span class="p">:</span> <span class="n">Path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">report_dir</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="n">fil_name</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">printer</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Path for log files was given. Overriding default&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">fil_path</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="n">fil_path</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1"># attach handlers to root logger</span>
        <span class="n">root_logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">()</span>
        <span class="n">root_logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">NOTSET</span><span class="p">)</span>
        <span class="c1"># create file handler which will log messages to screen.</span>
        <span class="c1"># in principle those are messages that come from logger &quot;printer&quot;</span>
        <span class="n">screen_handler</span> <span class="o">=</span> <span class="n">set_logger</span><span class="o">.</span><span class="n">PrinterScreenHandler</span><span class="p">()</span>
        <span class="n">screen_handler</span><span class="o">.</span><span class="n">addFilter</span><span class="p">(</span><span class="n">set_logger</span><span class="o">.</span><span class="n">Filter_name</span><span class="p">(</span><span class="s2">&quot;printer&quot;</span><span class="p">))</span>
        <span class="n">screen_handler</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
        <span class="n">root_logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">screen_handler</span><span class="p">)</span>
        <span class="c1"># Add a second screen handler to root logger to print out warning+ messages</span>
        <span class="n">screen_handler_high</span> <span class="o">=</span> <span class="n">set_logger</span><span class="o">.</span><span class="n">ColoredDetailedScreenHandler</span><span class="p">()</span>
        <span class="n">screen_handler_high</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">WARNING</span><span class="p">)</span>
        <span class="n">root_logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">screen_handler_high</span><span class="p">)</span>
        <span class="c1"># create file handler which will log messages to file.</span>
        <span class="c1"># in principle those are messages that come from logger &quot;logger&quot;</span>
        <span class="n">file_handler</span> <span class="o">=</span> <span class="n">set_logger</span><span class="o">.</span><span class="n">DetailedFileHandler</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">fil_path</span><span class="si">}</span><span class="s2">.log&quot;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;w&quot;</span><span class="p">)</span>
        <span class="c1"># Put everything both logs in the file</span>
        <span class="n">file_handler</span><span class="o">.</span><span class="n">addFilter</span><span class="p">(</span><span class="n">set_logger</span><span class="o">.</span><span class="n">Filter_name</span><span class="p">([</span><span class="s2">&quot;TFM&quot;</span><span class="p">,</span> <span class="s2">&quot;printer&quot;</span><span class="p">]))</span>
        <span class="n">file_handler</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
        <span class="n">root_logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">file_handler</span><span class="p">)</span>
        <span class="c1"># create file handler which will log all messages to file in json format.</span>
        <span class="n">json_handler</span> <span class="o">=</span> <span class="n">set_logger</span><span class="o">.</span><span class="n">PersistentLogHandler</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">fil_path</span><span class="si">}</span><span class="s2">.jsonl&quot;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;w&quot;</span><span class="p">)</span>
        <span class="n">json_handler</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
        <span class="c1"># No filter is needed because it will log all messages</span>
        <span class="n">root_logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">json_handler</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Loggers configured.&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Log and report files will be saved in </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">fil_path</span><span class="p">)</span></div>


<div class="viewcode-block" id="ModelApi.wipe_handlers">
<a class="viewcode-back" href="../model_api.html#model_api.ModelApi.wipe_handlers">[docs]</a>
    <span class="k">def</span> <span class="nf">wipe_handlers</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Wipe the loggers from the root logger.</span>

<span class="sd">        This eliminates all handlers from the root logger.</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">root_logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Wiping all handlers.&quot;</span><span class="p">)</span>
        <span class="n">handlers</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">root_logger</span><span class="o">.</span><span class="n">handlers</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">handler</span> <span class="ow">in</span> <span class="n">handlers</span><span class="p">:</span>
            <span class="n">root_logger</span><span class="o">.</span><span class="n">removeHandler</span><span class="p">(</span><span class="n">handler</span><span class="p">)</span></div>


<div class="viewcode-block" id="ModelApi.reconfigure_loggers">
<a class="viewcode-back" href="../model_api.html#model_api.ModelApi.reconfigure_loggers">[docs]</a>
    <span class="k">def</span> <span class="nf">reconfigure_loggers</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Reconfigure the loggers.</span>

<span class="sd">        This function will wipe the handlers from the root logger and then reconfigure them.</span>
<span class="sd">        This assures that the configuration is updated by the user, otherwise</span>
<span class="sd">        it will use the default configuration.</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wipe_handlers</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">configure_default_loggers</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Loggers reconfigured.&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s2">&quot;All handlers wiped and reconfigured.&quot;</span>
            <span class="s2">&quot;This includes any handlers added by the user!&quot;</span>
            <span class="p">)</span></div>


<div class="viewcode-block" id="ModelApi.configure_dataset">
<a class="viewcode-back" href="../model_api.html#model_api.ModelApi.configure_dataset">[docs]</a>
    <span class="k">def</span> <span class="nf">configure_dataset</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
            <span class="n">input_columns</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span>
            <span class="n">output_columns</span><span class="p">:</span> <span class="nb">list</span>
            <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CategoricDataset</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Configure the dataset for training the model.</span>

<span class="sd">        Args:</span>
<span class="sd">            df (pd.DataFrame): The DataFrame to be used.</span>
<span class="sd">            input_columns (list): The columns to be used as input.</span>
<span class="sd">            output_columns (list): The columns to be used as output.</span>

<span class="sd">        Returns:</span>
<span class="sd">            dataset (CategoricDataset): The configured dataset.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># statements to make sure the input is correct</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">input_columns</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;input_columns must be a list&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">output_columns</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;output_columns must be a list&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;df must be a pandas DataFrame&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">input_columns</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;input_columns must have at least one element&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">output_columns</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;output_columns must have exactly one element&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="n">col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">input_columns</span><span class="p">]):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;input_columns must be columns in the DataFrame&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="n">col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">output_columns</span><span class="p">]):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;output_columns must be columns in the DataFrame&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="n">col</span> <span class="ow">in</span> <span class="n">output_columns</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">input_columns</span><span class="p">]):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;input_columns and output_columns must have different elements&quot;</span><span class="p">)</span>

        <span class="c1"># create the dataset</span>
        <span class="n">dataset</span><span class="p">:</span> <span class="n">CategoricDataset</span> <span class="o">=</span> <span class="n">CategoricDataset</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">df</span><span class="p">)</span>
        <span class="c1"># define the input and output columns and create auxiliary variables</span>
        <span class="n">dataset</span><span class="o">.</span><span class="n">define_input_output</span><span class="p">(</span><span class="n">input_columns</span><span class="o">=</span><span class="n">input_columns</span><span class="p">,</span> <span class="n">output_columns</span><span class="o">=</span><span class="n">output_columns</span><span class="p">,</span> <span class="n">store_input_features</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Dataset configured.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">dataset</span></div>


<div class="viewcode-block" id="ModelApi.get_dataloaders">
<a class="viewcode-back" href="../model_api.html#model_api.ModelApi.get_dataloaders">[docs]</a>
    <span class="k">def</span> <span class="nf">get_dataloaders</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">dataset</span><span class="p">:</span> <span class="n">CategoricDataset</span><span class="p">,</span>
            <span class="n">train_size</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">balance_training_data</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">aggregate_outputs</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the dataloaders for the training and testing of the model.</span>

<span class="sd">        Args:</span>
<span class="sd">            dataset (CategoricDataset): The dataset to be used.</span>
<span class="sd">            train_size (float): The proportion of the dataset to be used for training.</span>
<span class="sd">                                If None, it will use the configuration in ConfigRun.</span>
<span class="sd">            batch_size (int): The batch size to be used.</span>
<span class="sd">                            If None, it will use the configuration in ConfigRun.</span>

<span class="sd">            balance_training_data (bool): Whether to balance the training data.</span>
<span class="sd">                                        This is done by oversampling the minority classes.</span>

<span class="sd">            aggregate_outputs (bool): Whether to aggregate the outputs.</span>
<span class="sd">                                    This is useful if some input appears multiple times</span>
<span class="sd">                                        with different outputs.</span>

<span class="sd">        Returns:</span>
<span class="sd">            train_dataloader (DataLoader): The DataLoader for the training dataset.</span>
<span class="sd">            test_dataloader (DataLoader or None): The DataLoader for the testing dataset.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">batch_size</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">batch_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">batch_size</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Batch size was set to </span><span class="si">%d</span><span class="s2"> overriding the config&quot;</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">train_size</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">train_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">train_size</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Train size was set to </span><span class="si">%.2f</span><span class="s2"> overriding the config&quot;</span><span class="p">,</span> <span class="n">train_size</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">balance_training_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">balance_training_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">balance_training_data</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;balance_training_data was set to </span><span class="si">%s</span><span class="s2"> overriding the config&quot;</span><span class="p">,</span> <span class="n">balance_training_data</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">aggregate_outputs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">aggregate_outputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">aggregate_outputs</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;aggregate_outputs was set to </span><span class="si">%s</span><span class="s2"> overriding the config&quot;</span><span class="p">,</span> <span class="n">aggregate_outputs</span><span class="p">)</span>

        <span class="n">train_dataset</span><span class="p">:</span> <span class="n">CategoricDataset</span>
        <span class="n">test_dataset</span><span class="p">:</span> <span class="n">CategoricDataset</span>
        <span class="n">train_dataset</span><span class="p">,</span> <span class="n">test_dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">train_test_split</span><span class="p">(</span><span class="n">train_size</span><span class="o">=</span><span class="n">train_size</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">balance_training_data</span><span class="p">:</span>
            <span class="n">train_dataset</span><span class="o">.</span><span class="n">balance</span><span class="p">(</span><span class="n">train_dataset</span><span class="o">.</span><span class="n">output_columns</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">train_dataloader</span><span class="p">:</span> <span class="n">DataLoader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span>
            <span class="n">dataset</span><span class="o">=</span><span class="n">train_dataset</span><span class="p">,</span>
            <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
            <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">drop_last</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">aggregate_outputs</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Aggregating outputs in the dataframe.&quot;</span><span class="p">)</span>
            <span class="n">test_dataset</span><span class="o">.</span><span class="n">group_by</span><span class="p">()</span>
        <span class="n">test_dataloader</span><span class="p">:</span> <span class="n">DataLoader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span>
            <span class="n">dataset</span><span class="o">=</span><span class="n">test_dataset</span><span class="p">,</span>
            <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
            <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">drop_last</span><span class="o">=</span><span class="kc">False</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">train_dataloader</span><span class="p">,</span> <span class="n">test_dataloader</span></div>


<div class="viewcode-block" id="ModelApi.create_model">
<a class="viewcode-back" href="../model_api.html#model_api.ModelApi.create_model">[docs]</a>
    <span class="k">def</span> <span class="nf">create_model</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">dataset</span><span class="p">:</span> <span class="n">CategoricDataset</span><span class="p">,</span>
            <span class="n">use_input_embedding</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">use_output_embedding</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">max_hidden_neurons</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">hidden_layers</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">train_nlp_embedding</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">nlp_model_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CategoricNeuralNetwork</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a categoric neural network model.</span>

<span class="sd">        Args:</span>
<span class="sd">            dataset (CategoricDataset): The dataset to be used for training the model.</span>
<span class="sd">            use_input_embedding (bool): Whether to use input embedding in the model.</span>
<span class="sd">            use_output_embedding (bool): Whether to use output embedding in the model.</span>
<span class="sd">            max_hidden_neurons (int): The maximum number of hidden neurons in the model.</span>
<span class="sd">            hidden_layers (int): The number of hidden layers in the model.</span>
<span class="sd">            train_nlp_embedding (bool): Whether to train the NLP embedding in the model.</span>
<span class="sd">            nlp_model_name (str): The name of the NLP model to be used.</span>

<span class="sd">        Returns:</span>
<span class="sd">            model (CategoricNeuralNetwork): The created categoric neural network model.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="n">dataset</span><span class="o">.</span><span class="n">already_configured</span><span class="p">,</span> <span class="s2">&quot;The dataset must be configured before creating the model.&quot;</span>
        <span class="k">if</span> <span class="n">use_input_embedding</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">use_input_embedding</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">model_uses_input_embedding</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;use_input_embedding was set to </span><span class="si">%s</span><span class="s2"> overriding the config&quot;</span><span class="p">,</span> <span class="n">use_input_embedding</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">use_output_embedding</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">use_output_embedding</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">model_uses_output_embedding</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;use_output_embedding was set to </span><span class="si">%s</span><span class="s2"> overriding the config&quot;</span><span class="p">,</span> <span class="n">use_output_embedding</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">train_nlp_embedding</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">train_nlp_embedding</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">model_trains_nlp_embedding</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;train_nlp_embedding was set to </span><span class="si">%s</span><span class="s2"> overriding the config&quot;</span><span class="p">,</span> <span class="n">train_nlp_embedding</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">nlp_model_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">nlp_model_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">nlp_model_name</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;nlp_model_name was set to </span><span class="si">%s</span><span class="s2"> overriding the config&quot;</span><span class="p">,</span> <span class="n">nlp_model_name</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">max_hidden_neurons</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">max_hidden_neurons</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">max_hidden_neurons</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;max_hidden_neurons was set to </span><span class="si">%d</span><span class="s2"> overriding the config&quot;</span><span class="p">,</span> <span class="n">max_hidden_neurons</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">hidden_layers</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">hidden_layers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">hidden_layers</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;hidden_layers was set to </span><span class="si">%d</span><span class="s2"> overriding the config&quot;</span><span class="p">,</span> <span class="n">hidden_layers</span><span class="p">)</span>

        <span class="n">info_message</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">info_message</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Details on the model:&quot;</span><span class="p">)</span>
        <span class="n">info_message</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Dataset: Trying to relate</span><span class="si">{</span><span class="n">dataset</span><span class="o">.</span><span class="n">input_columns</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">dataset</span><span class="o">.</span><span class="n">output_columns</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">info_message</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;use_input_embedding = </span><span class="si">{</span><span class="n">use_input_embedding</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">info_message</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;use_output_embedding = </span><span class="si">{</span><span class="n">use_output_embedding</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">info_message</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;max_hidden_neurons = </span><span class="si">{</span><span class="n">max_hidden_neurons</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">info_message</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;hidden_layers = </span><span class="si">{</span><span class="n">hidden_layers</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">info_message</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;train_nlp_embedding = </span><span class="si">{</span><span class="n">train_nlp_embedding</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">info_message</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;nlp_model_name = </span><span class="si">{</span><span class="n">nlp_model_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">printer</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">info_message</span><span class="p">))</span>

        <span class="n">model</span><span class="p">:</span> <span class="n">CategoricNeuralNetwork</span> <span class="o">=</span> <span class="n">CategoricNeuralNetwork</span><span class="p">(</span>
            <span class="n">category_mappings</span><span class="o">=</span><span class="n">dataset</span><span class="o">.</span><span class="n">category_mappings</span><span class="p">,</span>
            <span class="n">use_input_embedding</span><span class="o">=</span><span class="n">use_input_embedding</span><span class="p">,</span>
            <span class="n">use_output_embedding</span><span class="o">=</span><span class="n">use_output_embedding</span><span class="p">,</span>
            <span class="n">max_hidden_neurons</span><span class="o">=</span><span class="n">max_hidden_neurons</span><span class="p">,</span>
            <span class="n">hidden_layers</span><span class="o">=</span><span class="n">hidden_layers</span><span class="p">,</span>
            <span class="n">train_nlp_embedding</span><span class="o">=</span><span class="n">train_nlp_embedding</span><span class="p">,</span>
            <span class="n">nlp_model_name</span><span class="o">=</span><span class="n">nlp_model_name</span>
            <span class="p">)</span>
        <span class="n">model</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">model</span></div>


<div class="viewcode-block" id="ModelApi.get_optimizer">
<a class="viewcode-back" href="../model_api.html#model_api.ModelApi.get_optimizer">[docs]</a>
    <span class="k">def</span> <span class="nf">get_optimizer</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">model</span><span class="p">:</span> <span class="n">CategoricNeuralNetwork</span><span class="p">,</span>
            <span class="n">learning_rate</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">optimizer_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;AdamW&quot;</span>
            <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Optimizer</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the optimizer for the model.</span>

<span class="sd">        Args:</span>
<span class="sd">            model (CategoricNeuralNetwork): The model to be used.</span>
<span class="sd">            learning_rate (float): The learning rate for the optimizer.</span>
<span class="sd">            optimizer_name (str): The name of the optimizer to be used.</span>
<span class="sd">                                Must be one of &quot;AdamW&quot;, &quot;SGD&quot;, or &quot;Adam&quot;.</span>

<span class="sd">        Returns:</span>
<span class="sd">            optimizer (torch.optim.Optimizer): The optimizer to be used.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># check the input</span>
        <span class="k">if</span> <span class="n">learning_rate</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">learning_rate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">learning_rate</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Learning rate was set to </span><span class="si">%.2e</span><span class="s2"> overriding the config&quot;</span><span class="p">,</span> <span class="n">learning_rate</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">optimizer_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">optimizer_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">optimizer_name</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;optimizer_name was set to </span><span class="si">%s</span><span class="s2"> overriding the config&quot;</span><span class="p">,</span> <span class="n">optimizer_name</span><span class="p">)</span>

        <span class="c1"># create the optimizer</span>
        <span class="k">if</span> <span class="n">optimizer_name</span> <span class="o">==</span> <span class="s2">&quot;AdamW&quot;</span><span class="p">:</span>
            <span class="n">optimizer</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">AdamW</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="n">learning_rate</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">optimizer_name</span> <span class="o">==</span> <span class="s2">&quot;SGD&quot;</span><span class="p">:</span>
            <span class="n">optimizer</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">SGD</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="n">learning_rate</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">optimizer_name</span> <span class="o">==</span> <span class="s2">&quot;Adam&quot;</span><span class="p">:</span>
            <span class="n">optimizer</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="n">learning_rate</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;optimizer_name must be one of &#39;AdamW&#39;, &#39;SGD&#39;, or &#39;Adam&#39;.&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Optimizer created.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">optimizer</span></div>


<div class="viewcode-block" id="ModelApi.get_scheduler">
<a class="viewcode-back" href="../model_api.html#model_api.ModelApi.get_scheduler">[docs]</a>
    <span class="k">def</span> <span class="nf">get_scheduler</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">optimizer</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Optimizer</span><span class="p">,</span>
            <span class="n">factor</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span>
            <span class="n">mode</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">patience</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">steps</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">scheduler_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">lr_scheduler</span><span class="o">.</span><span class="n">_LRScheduler</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the scheduler for the optimizer.</span>

<span class="sd">        Args:</span>
<span class="sd">            optimizer (torch.optim.Optimizer): The optimizer to be used.</span>
<span class="sd">            factor (float): The factor by which the learning rate will be decayed.</span>
<span class="sd">            mode (str): The mode for the scheduler.</span>
<span class="sd">            patience (int): The patience for the scheduler.</span>
<span class="sd">            steps (int): The steps for the scheduler.</span>
<span class="sd">            scheduler_type (str): The type of the scheduler.</span>
<span class="sd">                                Must be one of &quot;ReduceLROnPlateau&quot; or &quot;StepLR&quot;.</span>

<span class="sd">        Returns:</span>
<span class="sd">            scheduler (torch.optim.lr_scheduler._LRScheduler): The scheduler to be used.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># check the input</span>
        <span class="k">if</span> <span class="n">scheduler_type</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">scheduler_type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">scheduler_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">scheduler_type</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">scheduler_type</span> <span class="o">=</span> <span class="s2">&quot;ReduceLROnPlateau&quot;</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;scheduler_type was not set. Using ReduceLROnPlateau.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;scheduler_type was set to </span><span class="si">%s</span><span class="s2"> overriding the config&quot;</span><span class="p">,</span> <span class="n">scheduler_type</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">factor</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">factor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">lr_decay_factor</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;learning rate decay factor was set to </span><span class="si">%.2f</span><span class="s2"> overriding the config&quot;</span><span class="p">,</span> <span class="n">factor</span><span class="p">)</span>
        <span class="c1"># create the scheduler</span>
        <span class="k">if</span> <span class="n">scheduler_type</span> <span class="o">==</span> <span class="s2">&quot;ReduceLROnPlateau&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">patience</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">patience</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">lr_decay_patience</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;learning rate decay patience was set to </span><span class="si">%d</span><span class="s2"> overriding the config&quot;</span><span class="p">,</span> <span class="n">patience</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">mode</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">mode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">scheduler_plateau_mode</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;scheduler_plateau_mode was set to </span><span class="si">%s</span><span class="s2"> overriding the config&quot;</span><span class="p">,</span> <span class="n">mode</span><span class="p">)</span>
            <span class="c1"># if the scheduler is ReduceLROnPlateau, the steps will be ignored</span>
            <span class="k">if</span> <span class="n">steps</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s2">&quot;Steps is not used in ReduceLROnPlateau scheduler.&quot;</span>
                    <span class="s2">&quot; However it was set in the function call.&quot;</span>
                    <span class="s2">&quot; It will be ignored.&quot;</span>
                    <span class="p">)</span>
            <span class="n">scheduler</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">lr_scheduler</span><span class="o">.</span><span class="n">ReduceLROnPlateau</span><span class="p">(</span>
                <span class="n">optimizer</span><span class="o">=</span><span class="n">optimizer</span><span class="p">,</span>
                <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">,</span>
                <span class="n">factor</span><span class="o">=</span><span class="n">factor</span><span class="p">,</span>
                <span class="n">patience</span><span class="o">=</span><span class="n">patience</span>
                <span class="p">)</span>
        <span class="k">elif</span> <span class="n">scheduler_type</span> <span class="o">==</span> <span class="s2">&quot;StepLR&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">steps</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">steps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">lr_decay_step</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;learning rate decay step was set to </span><span class="si">%d</span><span class="s2"> overriding the config&quot;</span><span class="p">,</span> <span class="n">steps</span><span class="p">)</span>
            <span class="c1"># if the scheduler is StepLR, the patience will be ignored</span>
            <span class="k">if</span> <span class="n">patience</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s2">&quot;Patience is not used in StepLR scheduler.&quot;</span>
                    <span class="s2">&quot; However it was set in the function call.&quot;</span>
                    <span class="s2">&quot; It will be ignored.&quot;</span>
                    <span class="p">)</span>
            <span class="c1"># if the scheduler is StepLR, the mode will be ignored</span>
            <span class="k">if</span> <span class="n">mode</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s2">&quot;Mode is not used in StepLR scheduler.&quot;</span>
                    <span class="s2">&quot; However it was set in the function call.&quot;</span>
                    <span class="s2">&quot; It will be ignored.&quot;</span>
                    <span class="p">)</span>
            <span class="n">scheduler</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">lr_scheduler</span><span class="o">.</span><span class="n">StepLR</span><span class="p">(</span>
                <span class="n">optimizer</span><span class="o">=</span><span class="n">optimizer</span><span class="p">,</span>
                <span class="n">step_size</span><span class="o">=</span><span class="n">steps</span><span class="p">,</span>
                <span class="n">gamma</span><span class="o">=</span><span class="n">factor</span>
                <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;scheduler_type must be one of &#39;StepLR&#39; or &#39;ReduceLROnPlateau&#39;.&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Scheduler created: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">scheduler</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">scheduler</span></div>


<div class="viewcode-block" id="ModelApi.get_loss_fn">
<a class="viewcode-back" href="../model_api.html#model_api.ModelApi.get_loss_fn">[docs]</a>
    <span class="k">def</span> <span class="nf">get_loss_fn</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">use_output_embedding</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the loss function for the model.</span>

<span class="sd">        Args:</span>
<span class="sd">            use_output_embedding (bool): Whether to use an embedding layer for the output.</span>
<span class="sd">                                        If None, it will use the configuration in ConfigRun.</span>
<span class="sd">                                        This decides the loss function to be used.</span>

<span class="sd">        Returns:</span>
<span class="sd">            loss_fn (torch.nn.Module): The loss function to be used.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">use_output_embedding</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">use_output_embedding</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">model_uses_output_embedding</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;use_output_embedding was set to </span><span class="si">%s</span><span class="s2"> overriding the config&quot;</span><span class="p">,</span> <span class="n">use_output_embedding</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">use_output_embedding</span><span class="p">:</span>
            <span class="n">loss_fn</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">CosineEmbeddingLoss</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">loss_fn</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">BCEWithLogitsLoss</span><span class="p">()</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Loss function created: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">loss_fn</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">loss_fn</span></div>


<div class="viewcode-block" id="ModelApi.train">
<a class="viewcode-back" href="../model_api.html#model_api.ModelApi.train">[docs]</a>
    <span class="k">def</span> <span class="nf">train</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">model</span><span class="p">:</span> <span class="n">CategoricNeuralNetwork</span><span class="p">,</span>
            <span class="n">train_dataloader</span><span class="p">:</span> <span class="n">DataLoader</span><span class="p">,</span>
            <span class="n">test_dataloader</span><span class="p">:</span> <span class="n">DataLoader</span><span class="p">,</span>
            <span class="n">loss_fn</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">,</span>
            <span class="n">optimizer</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Optimizer</span><span class="p">,</span>
            <span class="n">train_targets</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">epochs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">lr_decay_target</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">scheduler</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">lr_scheduler</span><span class="o">.</span><span class="n">_LRScheduler</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">do_report</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
            <span class="n">live_report</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Train the model on the dataset.</span>

<span class="sd">        Args:</span>
<span class="sd">            Necessary:</span>
<span class="sd">                model (CategoricNeuralNetwork): The model to be trained.</span>
<span class="sd">                train_dataloader (DataLoader): The DataLoader for the training dataset.</span>
<span class="sd">                test_dataloader (DataLoader): The DataLoader for the testing dataset.</span>
<span class="sd">                loss_fn (torch.nn.Module): The loss function to be used.</span>
<span class="sd">                optimizer (torch.optim.Optimizer): The optimizer to be used.</span>

<span class="sd">            Optional (will default to the values in ConfigRun):</span>
<span class="sd">                scheduler (torch.optim.lr_scheduler._LRScheduler): The scheduler to be used.</span>
<span class="sd">                epochs (int): The number of epochs to train the model.</span>
<span class="sd">                train_targets (dict): The targets for the training.</span>
<span class="sd">                lr_decay_target (str): The target for the learning rate decay.</span>
<span class="sd">                                    Only relevant if the scheduler is ReduceLROnPlateau.</span>

<span class="sd">            Optional (will default to the values in the function call):</span>
<span class="sd">                do_report (bool): Whether to generate a report.</span>
<span class="sd">                live_report (bool): Whether to generate a live report.</span>


<span class="sd">        Returns:</span>
<span class="sd">            None</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">epochs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">epochs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">epochs</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Epochs was set to </span><span class="si">%d</span><span class="s2"> overriding the config&quot;</span><span class="p">,</span> <span class="n">epochs</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">train_targets</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">train_targets</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">train_targets</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;train_targets was set to </span><span class="si">%s</span><span class="s2"> overriding the config&quot;</span><span class="p">,</span> <span class="n">train_targets</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">scheduler</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">lr_scheduler</span><span class="o">.</span><span class="n">ReduceLROnPlateau</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">lr_decay_target</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">lr_decay_target</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">lr_decay_target</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;lr_decay_target was set to </span><span class="si">%s</span><span class="s2"> overriding the config&quot;</span><span class="p">,</span> <span class="n">lr_decay_target</span><span class="p">)</span>

        <span class="c1"># Define targets for training</span>
        <span class="n">f1_target</span> <span class="o">=</span> <span class="n">train_targets</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;f1&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">precision_target</span> <span class="o">=</span> <span class="n">train_targets</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;precision&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">recall_target</span> <span class="o">=</span> <span class="n">train_targets</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;recall&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="n">monitor_f1</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">f1_target</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="n">monitor_precision</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">precision_target</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="n">monitor_recall</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">recall_target</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

        <span class="n">info_message</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">info_message</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Details on the training:&quot;</span><span class="p">)</span>
        <span class="n">info_message</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Model: </span><span class="si">{</span><span class="n">model</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">info_message</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loss Function: </span><span class="si">{</span><span class="n">loss_fn</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">info_message</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Optimizer: </span><span class="si">{</span><span class="n">optimizer</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">info_message</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Scheduler: </span><span class="si">{</span><span class="n">scheduler</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">info_message</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Epochs: </span><span class="si">{</span><span class="n">epochs</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">info_message</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Configuration: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">print</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">monitor_f1</span><span class="p">:</span>
            <span class="n">info_message</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;f1_target = </span><span class="si">{</span><span class="n">f1_target</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">monitor_precision</span><span class="p">:</span>
            <span class="n">info_message</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;precision_target = </span><span class="si">{</span><span class="n">precision_target</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">monitor_recall</span><span class="p">:</span>
            <span class="n">info_message</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;recall_target = </span><span class="si">{</span><span class="n">recall_target</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">info_message</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">printer</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">info_message</span><span class="p">))</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">do_report</span><span class="p">:</span>
                <span class="n">df</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">epochs</span><span class="p">):</span>
                <span class="n">printer</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Epoch </span><span class="si">%d</span><span class="se">\n</span><span class="s2">-------------------------------&quot;</span><span class="p">,</span> <span class="n">t</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">model</span><span class="o">.</span><span class="n">train_loop</span><span class="p">(</span><span class="n">train_dataloader</span><span class="p">,</span> <span class="n">loss_fn</span><span class="p">,</span> <span class="n">optimizer</span><span class="p">)</span>
                <span class="n">f1_score</span><span class="p">,</span> <span class="n">precision</span><span class="p">,</span> <span class="n">recall</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">test_loop</span><span class="p">(</span><span class="n">test_dataloader</span><span class="p">,</span> <span class="n">loss_fn</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">scheduler</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">lr_1</span> <span class="o">=</span> <span class="n">scheduler</span><span class="o">.</span><span class="n">get_last_lr</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">scheduler</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">lr_scheduler</span><span class="o">.</span><span class="n">ReduceLROnPlateau</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">lr_decay_target</span> <span class="o">==</span> <span class="s2">&quot;f1&quot;</span><span class="p">:</span>
                            <span class="n">scheduler</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">f1_score</span><span class="p">)</span>
                        <span class="k">elif</span> <span class="n">lr_decay_target</span> <span class="o">==</span> <span class="s2">&quot;precision&quot;</span><span class="p">:</span>
                            <span class="n">scheduler</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">precision</span><span class="p">)</span>
                        <span class="k">elif</span> <span class="n">lr_decay_target</span> <span class="o">==</span> <span class="s2">&quot;recall&quot;</span><span class="p">:</span>
                            <span class="n">scheduler</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">recall</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;lr_decay_target must be &#39;f1&#39;, &#39;precision&#39;, or &#39;recall&#39;.&quot;</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">scheduler</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">lr_scheduler</span><span class="o">.</span><span class="n">StepLR</span><span class="p">):</span>
                        <span class="n">scheduler</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;scheduler must be ReduceLROnPlateau or StepLR.&quot;</span><span class="p">)</span>
                    <span class="n">lr_2</span> <span class="o">=</span> <span class="n">scheduler</span><span class="o">.</span><span class="n">get_last_lr</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">lr_1</span> <span class="o">!=</span> <span class="n">lr_2</span><span class="p">:</span>
                        <span class="n">printer</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Learning rate changed from </span><span class="si">%s</span><span class="s2"> to </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">lr_1</span><span class="p">,</span> <span class="n">lr_2</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">lr_2</span> <span class="o">&lt;=</span> <span class="mf">1e-7</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                                <span class="s2">&quot;Learning rate got too small.&quot;</span>
                                <span class="s2">&quot;Interrupting training, meaningless to continue.&quot;</span>
                                <span class="s2">&quot;Increase patience or decrease factor.&quot;</span>
                                <span class="p">)</span>
                            <span class="k">raise</span> <span class="n">StopTraining</span><span class="p">(</span><span class="s2">&quot;Training Stopped. Learning rate too small.&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">do_report</span><span class="p">:</span>
                    <span class="n">new_row</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
                        <span class="s2">&quot;Epoch&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">t</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span>
                        <span class="s2">&quot;F1&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">f1_score</span><span class="p">],</span>
                        <span class="s2">&quot;Precision&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">precision</span><span class="p">],</span>
                        <span class="s2">&quot;Recall&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">recall</span><span class="p">],</span>
                        <span class="s2">&quot;Time&quot;</span><span class="p">:</span> <span class="p">[(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)</span> <span class="o">/</span> <span class="mi">60</span><span class="p">]}</span>
                        <span class="p">)</span>
                    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df</span><span class="p">,</span> <span class="n">new_row</span><span class="p">],</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">live_report</span><span class="p">:</span>
                        <span class="c1"># Real-time plotting with Seaborn</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Updating Plotted report live.&quot;</span><span class="p">)</span>
                        <span class="n">plt</span><span class="o">.</span><span class="n">ion</span><span class="p">()</span>
                        <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>  <span class="c1"># Clear the current figure</span>
                        <span class="k">if</span> <span class="s2">&quot;f1&quot;</span> <span class="ow">in</span> <span class="n">train_targets</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                            <span class="n">color</span> <span class="o">=</span> <span class="s2">&quot;red&quot;</span>
                            <span class="n">sns</span><span class="o">.</span><span class="n">lineplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">&#39;Epoch&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;F1&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">df</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;F1 Score&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">)</span>
                            <span class="n">sns</span><span class="o">.</span><span class="n">lineplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">&#39;Epoch&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">train_targets</span><span class="p">[</span><span class="s2">&quot;f1&quot;</span><span class="p">],</span> <span class="n">data</span><span class="o">=</span><span class="n">df</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;F1 Target&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">)</span>
                        <span class="k">if</span> <span class="s2">&quot;recall&quot;</span> <span class="ow">in</span> <span class="n">train_targets</span><span class="p">:</span>
                            <span class="n">color</span> <span class="o">=</span> <span class="s2">&quot;green&quot;</span>
                            <span class="n">sns</span><span class="o">.</span><span class="n">lineplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">&#39;Epoch&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;Recall&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">df</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Recall&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">)</span>
                            <span class="n">sns</span><span class="o">.</span><span class="n">lineplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">&#39;Epoch&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">train_targets</span><span class="p">[</span><span class="s2">&quot;recall&quot;</span><span class="p">],</span> <span class="n">data</span><span class="o">=</span><span class="n">df</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Recall Target&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">)</span>
                        <span class="k">if</span> <span class="s2">&quot;precision&quot;</span> <span class="ow">in</span> <span class="n">train_targets</span><span class="p">:</span>
                            <span class="n">color</span> <span class="o">=</span> <span class="s2">&quot;blue&quot;</span>
                            <span class="n">sns</span><span class="o">.</span><span class="n">lineplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">&#39;Epoch&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;Precision&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">df</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Precision&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">)</span>
                            <span class="n">sns</span><span class="o">.</span><span class="n">lineplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">&#39;Epoch&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">train_targets</span><span class="p">[</span><span class="s2">&quot;precision&quot;</span><span class="p">],</span> <span class="n">data</span><span class="o">=</span><span class="n">df</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Precision Target&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">)</span>
                        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
                        <span class="n">plt</span><span class="o">.</span><span class="n">pause</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>  <span class="c1"># Pause to update the plot</span>
                        <span class="n">plt</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>  <span class="c1"># Ensure the plot is updated</span>

                <span class="k">if</span> <span class="nb">all</span><span class="p">([</span>
                    <span class="n">f1_score</span> <span class="o">&gt;</span> <span class="n">f1_target</span> <span class="k">if</span> <span class="n">monitor_f1</span> <span class="k">else</span> <span class="kc">True</span><span class="p">,</span>
                    <span class="n">precision</span> <span class="o">&gt;</span> <span class="n">precision_target</span> <span class="k">if</span> <span class="n">monitor_precision</span> <span class="k">else</span> <span class="kc">True</span><span class="p">,</span>
                    <span class="n">recall</span> <span class="o">&gt;</span> <span class="n">recall_target</span> <span class="k">if</span> <span class="n">monitor_recall</span> <span class="k">else</span> <span class="kc">True</span>
                <span class="p">]):</span>
                    <span class="k">raise</span> <span class="n">StopTraining</span><span class="p">(</span><span class="s2">&quot;Target reached.&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">StopTraining</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">printer</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Training interrupted by user.&quot;</span><span class="p">)</span>
        <span class="n">printer</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Time taken: </span><span class="si">%.2f</span><span class="s2"> minutes.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)</span> <span class="o">/</span> <span class="mi">60</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">do_report</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_write_report</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">train_targets</span><span class="o">=</span><span class="n">train_targets</span><span class="p">)</span></div>


    <span class="k">def</span> <span class="nf">_write_report</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
            <span class="n">train_targets</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Write a report to a file.</span>

<span class="sd">        Args:</span>
<span class="sd">            df (pd.DataFrame): The DataFrame to be written.</span>
<span class="sd">            train_targets (dict): The targets for the training.</span>
<span class="sd">                                If there are targets, they will be plotted.</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">report_dir</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">report_filename</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">filename</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="n">filename</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">report</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">report</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Report on the training&quot;</span><span class="p">)</span>
        <span class="n">report</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;-------------------------------&quot;</span><span class="p">)</span>
        <span class="n">report</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">to_string</span><span class="p">())</span>
        <span class="n">report</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Ran for </span><span class="si">{</span><span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> epochs.&quot;</span><span class="p">)</span>
        <span class="n">report</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Final values:&quot;</span><span class="p">)</span>
        <span class="n">report</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;F1: </span><span class="si">{</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;F1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">report</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Precision: </span><span class="si">{</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Precision&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">report</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Recall: </span><span class="si">{</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Recall&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">report</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Time: </span><span class="si">{</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Time&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">printer</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">report</span><span class="p">))</span>
        <span class="n">sns</span><span class="o">.</span><span class="n">set_style</span><span class="p">(</span><span class="s2">&quot;darkgrid&quot;</span><span class="p">)</span>
        <span class="n">sns</span><span class="o">.</span><span class="n">set_context</span><span class="p">(</span><span class="s2">&quot;paper&quot;</span><span class="p">)</span>  <span class="c1"># Options: paper, notebook, talk, poster</span>
        <span class="c1"># save a plot of the report</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
        <span class="n">f1_color</span> <span class="o">=</span> <span class="s1">&#39;red&#39;</span>
        <span class="n">precision_color</span> <span class="o">=</span> <span class="s1">&#39;blue&#39;</span>
        <span class="n">recall_color</span> <span class="o">=</span> <span class="s1">&#39;green&#39;</span>
        <span class="n">sns</span><span class="o">.</span><span class="n">lineplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">&#39;Epoch&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;F1&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">df</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;F1 Score&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">f1_color</span><span class="p">)</span>
        <span class="n">sns</span><span class="o">.</span><span class="n">lineplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">&#39;Epoch&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;Recall&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">df</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Recall&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">recall_color</span><span class="p">)</span>
        <span class="n">sns</span><span class="o">.</span><span class="n">lineplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">&#39;Epoch&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;Precision&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">df</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Precision&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">precision_color</span><span class="p">)</span>
        <span class="c1"># print the training targets present</span>
        <span class="k">if</span> <span class="n">train_targets</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">train_targets</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;f1&quot;</span><span class="p">:</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">f1_color</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2"> target&quot;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;precision&quot;</span><span class="p">:</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">precision_color</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2"> target&quot;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;recall&quot;</span><span class="p">:</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">recall_color</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2"> target&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2"> target&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Score&quot;</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="s2">&quot;horizontal&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">case_name</span> <span class="o">!=</span> <span class="s2">&quot;default&quot;</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Training </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">case_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="c1"># save the</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Report saved as </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>

<div class="viewcode-block" id="ModelApi.build_and_train_model">
<a class="viewcode-back" href="../model_api.html#model_api.ModelApi.build_and_train_model">[docs]</a>
    <span class="k">def</span> <span class="nf">build_and_train_model</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
            <span class="n">input_columns</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span>
            <span class="n">output_columns</span><span class="p">:</span> <span class="nb">list</span>
            <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CategoricNeuralNetwork</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Build and train the model. Will make use of values in ConfigRun.</span>
<span class="sd">        They can be set before hand for a custom configuration.</span>

<span class="sd">        Args:</span>
<span class="sd">            df (pd.DataFrame): The dataset to be used.</span>
<span class="sd">            input_columns (list): The names of the columns to be used as input.</span>
<span class="sd">            output_columns (list): The names of the columns to be used as output.</span>

<span class="sd">        Returns:</span>
<span class="sd">            model (CategoricNeuralNetwork): The trained model.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Building and training the model automatically.&quot;</span><span class="p">)</span>
        <span class="n">dataset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">configure_dataset</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">input_columns</span><span class="p">,</span> <span class="n">output_columns</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Dataset configuration executed.&quot;</span><span class="p">)</span>
        <span class="n">train_dataloader</span><span class="p">,</span> <span class="n">test_dataloader</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_dataloaders</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Dataloaders creation executed.&quot;</span><span class="p">)</span>
        <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_model</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Model creation executed.&quot;</span><span class="p">)</span>
        <span class="n">loss_fn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_loss_fn</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Loss function creation executed.&quot;</span><span class="p">)</span>
        <span class="n">optimizer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_optimizer</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Optimizer creation executed.&quot;</span><span class="p">)</span>
        <span class="n">scheduler</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_scheduler</span><span class="p">(</span><span class="n">optimizer</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Scheduler creation executed.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">train</span><span class="p">(</span>
            <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
            <span class="n">train_dataloader</span><span class="o">=</span><span class="n">train_dataloader</span><span class="p">,</span>
            <span class="n">test_dataloader</span><span class="o">=</span><span class="n">test_dataloader</span><span class="p">,</span>
            <span class="n">loss_fn</span><span class="o">=</span><span class="n">loss_fn</span><span class="p">,</span>
            <span class="n">optimizer</span><span class="o">=</span><span class="n">optimizer</span><span class="p">,</span>
            <span class="n">scheduler</span><span class="o">=</span><span class="n">scheduler</span>
            <span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Training executed. Returning the trained model.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">model</span></div>


<div class="viewcode-block" id="ModelApi.save_model">
<a class="viewcode-back" href="../model_api.html#model_api.ModelApi.save_model">[docs]</a>
    <span class="k">def</span> <span class="nf">save_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="n">CategoricNeuralNetwork</span><span class="p">,</span> <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Path</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Save the model to a file.</span>

<span class="sd">        This will save the model and its initialization parameters to a file.</span>
<span class="sd">        Note that for a given model, 2 files are needed, the initialization parameters</span>
<span class="sd">        and the weights of the model parameters themselves.</span>

<span class="sd">        Args:</span>
<span class="sd">            model (CategoricalNeuralNetwork): The model to be saved.</span>
<span class="sd">            filename (str): The name of the file to save the model.</span>

<span class="sd">        Returns:</span>
<span class="sd">            None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">out_case_dir</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">case_name</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">Path</span><span class="p">):</span>
                <span class="n">filename</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Filename to save model was set to </span><span class="si">%s</span><span class="s2"> overriding the config&quot;</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">filename</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="n">filename</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">model_file</span> <span class="o">=</span> <span class="n">filename</span><span class="o">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="s2">&quot;.pth&quot;</span><span class="p">)</span>
        <span class="n">ini_file</span> <span class="o">=</span> <span class="n">filename</span><span class="o">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="s2">&quot;.ini&quot;</span><span class="p">)</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(),</span> <span class="n">model_file</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">ini_file</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fil</span><span class="p">:</span>
            <span class="n">fil</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()))</span>
            <span class="n">fil</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">fil</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">_config</span><span class="p">))</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Model saved as </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span></div>


<div class="viewcode-block" id="ModelApi.load_model">
<a class="viewcode-back" href="../model_api.html#model_api.ModelApi.load_model">[docs]</a>
    <span class="k">def</span> <span class="nf">load_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CategoricNeuralNetwork</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load a model from a file.</span>

<span class="sd">        Args:</span>
<span class="sd">            filename (str): The name of the file to load the model from.</span>

<span class="sd">        Returns:</span>
<span class="sd">            model (CategoricNeuralNetwork): The loaded model.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">ini_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span><span class="o">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="s2">&quot;.ini&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ini_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;File </span><span class="si">%s</span><span class="s2"> does not exist.&quot;</span><span class="p">,</span> <span class="n">ini_path</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="n">ini_path</span><span class="si">}</span><span class="s2"> does not exist.&quot;</span><span class="p">)</span>
        <span class="n">ini_params</span> <span class="o">=</span> <span class="n">ini_path</span><span class="o">.</span><span class="n">read_text</span><span class="p">(</span><span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>
        <span class="n">api_params</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">ini_params</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">model_params</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">ini_params</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">ConfigRun</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">api_params</span><span class="p">)</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">CategoricNeuralNetwork</span><span class="p">(</span><span class="o">**</span><span class="n">model_params</span><span class="p">)</span>
        <span class="n">model_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span><span class="o">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="s2">&quot;.pth&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">model_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;File </span><span class="si">%s</span><span class="s2"> does not exist.&quot;</span><span class="p">,</span> <span class="n">model_path</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="n">model_path</span><span class="si">}</span><span class="s2"> does not exist.&quot;</span><span class="p">)</span>
        <span class="n">model</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">model_path</span><span class="p">))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Model loaded from </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Changing the model to evaluation mode mode.&quot;</span><span class="p">)</span>
        <span class="n">model</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
        <span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">model</span></div>


<div class="viewcode-block" id="ModelApi.add_output_possibility">
<a class="viewcode-back" href="../model_api.html#model_api.ModelApi.add_output_possibility">[docs]</a>
    <span class="k">def</span> <span class="nf">add_output_possibility</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="n">CategoricNeuralNetwork</span><span class="p">,</span> <span class="n">output_category</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">output_value</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add a possibility for the output to the dataset.</span>

<span class="sd">        Args:</span>
<span class="sd">            model (CategoricNeuralNetwork): The model to be used.</span>
<span class="sd">            output_category (str): The name of the output category.</span>
<span class="sd">            output_value (str): The value of the output category.</span>
<span class="sd">        Returns:</span>
<span class="sd">            None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">model</span><span class="o">.</span><span class="n">add_output_possibility</span><span class="p">(</span><span class="n">output_category</span><span class="p">,</span> <span class="n">output_value</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Output possibility added to the model.&quot;</span><span class="p">)</span></div>
</div>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="k">pass</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, Enric Basso.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>